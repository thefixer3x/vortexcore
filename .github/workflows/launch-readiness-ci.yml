name: Launch Readiness CI

on:
  push:
    branches:
      - main
      - dev-cleanup
  pull_request:
    branches:
      - main

jobs:
  # Phase 1: Foundation Testing
  foundation-testing:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: bun install --frozen-lockfile
    
    - name: Run unit tests
      run: bun test
    
    - name: Run component tests
      run: bun run test:components || true # Allow failure initially
    
    - name: Test coverage report
      run: bun run test:coverage || true # Allow failure initially

  # Phase 1: E2E Testing
  e2e-testing:
    runs-on: ubuntu-latest
    needs: foundation-testing
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: bun install --frozen-lockfile
    
    - name: Setup Playwright dependencies
      uses: microsoft/playwright-github-action@v1
      with:
        install-dependencies: true
    
    - name: Install Playwright
      run: bunx playwright install
    
    - name: Build application
      run: bun run build
    
    - name: Run E2E tests
      run: bun run test:e2e || true # Allow failure initially
    
    - name: Upload E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results
        path: test-results/
        if-no-files-found: ignore

  # Phase 2: Build and Feature Validation
  feature-validation:
    runs-on: ubuntu-latest
    needs: foundation-testing
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: bun install --frozen-lockfile
    
    - name: Type checking
      run: bun run build
    
    - name: Linting
      run: bun run lint
    
    - name: Feature completeness check
      run: |
        echo "Checking feature completeness..."
        # Add custom scripts to validate feature completeness
        
  # Phase 3: Security Testing
  security-testing:
    runs-on: ubuntu-latest
    needs: feature-validation
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: bun install --frozen-lockfile
    
    - name: Run security audit
      run: bun audit || true # Allow failure initially
    
    - name: Dependency vulnerability scan
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: high
    
    - name: Security linting
      run: |
        echo "Running security-focused linting..."
        # Add ESLint security rules
        
  # Phase 4: Performance Testing
  performance-testing:
    runs-on: ubuntu-latest
    needs: feature-validation
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: bun install --frozen-lockfile
    
    - name: Build for performance testing
      run: bun run build
    
    - name: Run performance tests
      run: |
        echo "Running performance tests..."
        # Add Lighthouse CI or similar
        
  # Phase 5: Launch Readiness Check
  launch-readiness:
    runs-on: ubuntu-latest
    needs: [e2e-testing, security-testing, performance-testing]
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    
    - name: Compute readiness and generate report
      env:
        E2E_RESULT: ${{ needs.e2e-testing.result }}
        SECURITY_RESULT: ${{ needs.security-testing.result }}
        PERFORMANCE_RESULT: ${{ needs.performance-testing.result }}
        GIT_SHA: ${{ github.sha }}
      run: |
        echo "ðŸš€ Validating launch readiness..."
        echo "- e2e-testing result: ${E2E_RESULT}"
        echo "- security-testing result: ${SECURITY_RESULT}"
        echo "- performance-testing result: ${PERFORMANCE_RESULT}"

        pass_icon() { [ "$1" = "success" ] && echo "âœ…" || echo "âŒ"; }

        E2E_ICON=$(pass_icon "$E2E_RESULT")
        SEC_ICON=$(pass_icon "$SECURITY_RESULT")
        PERF_ICON=$(pass_icon "$PERFORMANCE_RESULT")

        OVERALL="PASS"
        if [ "$E2E_RESULT" != "success" ] || [ "$SECURITY_RESULT" != "success" ] || [ "$PERFORMANCE_RESULT" != "success" ]; then
          OVERALL="FAIL"
        fi

        {
          echo "# Launch Readiness Report"
          echo "Generated: $(date)"
          echo "Commit: ${GIT_SHA}"
          echo ""
          echo "## Phase Results"
          echo "- E2E Testing: ${E2E_ICON} (${E2E_RESULT})"
          echo "- Security Testing: ${SEC_ICON} (${SECURITY_RESULT})"
          echo "- Performance Testing: ${PERF_ICON} (${PERFORMANCE_RESULT})"
          echo ""
          echo "## Overall Status"
          echo "${OVERALL}"
        } > launch-report.md

        if [ "$OVERALL" = "FAIL" ]; then
          echo "âŒ Launch readiness failed â€” see report." >&2
          exit 1
        else
          echo "ðŸŽ‰ Ready for consumer launch!"
        fi
        
    - name: Upload launch readiness report
      uses: actions/upload-artifact@v4
      with:
        name: launch-readiness-report
        path: launch-report.md
